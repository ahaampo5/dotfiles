#!/usr/bin/env zsh
# ë©”ëª¨ë¦¬(RAM) ì •ë³´ í™•ì¸ í•¨ìˆ˜

function check_ram() {
    echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì •ë³´"
    echo "=================="
    
    if [[ "$(uname)" == "Darwin" ]]; then
        # macOSì—ì„œ ë©”ëª¨ë¦¬ ì •ë³´ í™•ì¸
        local total_mem=$(sysctl -n hw.memsize 2>/dev/null)
        
        if [[ -n "$total_mem" ]]; then
            # ë°”ì´íŠ¸ë¥¼ GBë¡œ ë³€í™˜
            local total_gb=$(echo "scale=2; $total_mem / 1024 / 1024 / 1024" | bc 2>/dev/null)
            echo "ì´ ë©”ëª¨ë¦¬: ${total_gb} GB"
        fi
        
        # vm_statì„ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
        if command -v vm_stat >/dev/null 2>&1; then
            local vm_info=$(vm_stat)
            local page_size=$(vm_stat | head -1 | grep -o '[0-9]*')
            
            # ê° ë©”ëª¨ë¦¬ íƒ€ì…ì˜ í˜ì´ì§€ ìˆ˜ ì¶”ì¶œ
            local free_pages=$(echo "$vm_info" | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
            local active_pages=$(echo "$vm_info" | grep "Pages active" | awk '{print $3}' | sed 's/\.//')
            local inactive_pages=$(echo "$vm_info" | grep "Pages inactive" | awk '{print $3}' | sed 's/\.//')
            local wired_pages=$(echo "$vm_info" | grep "Pages wired down" | awk '{print $4}' | sed 's/\.//')
            local compressed_pages=$(echo "$vm_info" | grep "Pages stored in compressor" | awk '{print $5}' | sed 's/\.//')
            
            if [[ -n "$page_size" && -n "$free_pages" ]]; then
                # í˜ì´ì§€ë¥¼ GBë¡œ ë³€í™˜
                local free_gb=$(echo "scale=2; $free_pages * $page_size / 1024 / 1024 / 1024" | bc 2>/dev/null)
                local active_gb=$(echo "scale=2; $active_pages * $page_size / 1024 / 1024 / 1024" | bc 2>/dev/null)
                local inactive_gb=$(echo "scale=2; $inactive_pages * $page_size / 1024 / 1024 / 1024" | bc 2>/dev/null)
                local wired_gb=$(echo "scale=2; $wired_pages * $page_size / 1024 / 1024 / 1024" | bc 2>/dev/null)
                
                local used_gb=$(echo "scale=2; $active_gb + $inactive_gb + $wired_gb" | bc 2>/dev/null)
                local usage_percent=$(echo "scale=1; $used_gb * 100 / $total_gb" | bc 2>/dev/null)
                
                echo "ì‚¬ìš© ì¤‘: ${used_gb} GB"
                echo "ì‚¬ìš© ê°€ëŠ¥: ${free_gb} GB"
                echo "ì‚¬ìš©ë¥ : ${usage_percent}%"
                echo ""
                echo "ì„¸ë¶€ ì •ë³´:"
                echo "  - Active: ${active_gb} GB"
                echo "  - Inactive: ${inactive_gb} GB"
                echo "  - Wired: ${wired_gb} GB"
                
                if [[ -n "$compressed_pages" ]]; then
                    local compressed_gb=$(echo "scale=2; $compressed_pages * $page_size / 1024 / 1024 / 1024" | bc 2>/dev/null)
                    echo "  - Compressed: ${compressed_gb} GB"
                fi
            fi
        fi
        
        # ë©”ëª¨ë¦¬ ì••ë°• ìƒíƒœ í™•ì¸
        local memory_pressure=$(memory_pressure 2>/dev/null | grep "System-wide memory free percentage" | awk '{print $6}' | sed 's/%//')
        if [[ -n "$memory_pressure" ]]; then
            echo "ë©”ëª¨ë¦¬ ì—¬ìœ ìœ¨: ${memory_pressure}%"
        fi
        
    else
        # Linux/Unix ì‹œìŠ¤í…œ
        if [[ -f /proc/meminfo ]]; then
            local total_kb=$(grep "MemTotal" /proc/meminfo | awk '{print $2}')
            local free_kb=$(grep "MemFree" /proc/meminfo | awk '{print $2}')
            local available_kb=$(grep "MemAvailable" /proc/meminfo | awk '{print $2}')
            
            local total_gb=$(echo "scale=2; $total_kb / 1024 / 1024" | bc)
            local free_gb=$(echo "scale=2; $free_kb / 1024 / 1024" | bc)
            local available_gb=$(echo "scale=2; $available_kb / 1024 / 1024" | bc)
            
            echo "ì´ ë©”ëª¨ë¦¬: ${total_gb} GB"
            echo "ì‚¬ìš© ê°€ëŠ¥: ${available_gb} GB"
            echo "ì—¬ìœ  ë©”ëª¨ë¦¬: ${free_gb} GB"
        fi
    fi
    
    echo ""
}

# í•¨ìˆ˜ ì‹¤í–‰ (ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ì‹¤í–‰ë  ë•Œ)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]] || [[ "${(%):-%x}" == "${0}" ]]; then
    check_ram "$@"
fi
