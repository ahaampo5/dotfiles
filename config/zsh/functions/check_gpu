#!/usr/bin/env zsh
# GPU ì •ë³´ í™•ì¸ í•¨ìˆ˜

function check_gpu() {
    echo "ğŸ® GPU ì •ë³´"
    echo "================"
    
    if [[ "$(uname)" == "Darwin" ]]; then
        # macOSì—ì„œ GPU ì •ë³´ í™•ì¸
        echo "ê·¸ë˜í”½ ì¹´ë“œ ì •ë³´:"
        
        # system_profilerë¥¼ ì‚¬ìš©í•˜ì—¬ GPU ì •ë³´ í™•ì¸
        local gpu_info=$(system_profiler SPDisplaysDataType 2>/dev/null)
        
        if [[ -n "$gpu_info" ]]; then
            echo "$gpu_info" | grep -E "(Chipset Model|VRAM|Resolution)" | while read line; do
                if [[ "$line" =~ "Chipset Model:" ]]; then
                    local model=$(echo "$line" | cut -d: -f2 | sed 's/^ *//')
                    echo "  ğŸ”§ ëª¨ë¸: ${model}"
                elif [[ "$line" =~ "VRAM" ]]; then
                    local vram=$(echo "$line" | cut -d: -f2 | sed 's/^ *//')
                    echo "  ğŸ’¾ VRAM: ${vram}"
                elif [[ "$line" =~ "Resolution:" ]]; then
                    local resolution=$(echo "$line" | cut -d: -f2 | sed 's/^ *//')
                    echo "  ğŸ“º í•´ìƒë„: ${resolution}"
                fi
            done
        fi
        
        # Metal ì§€ì› ì—¬ë¶€ í™•ì¸
        echo ""
        echo "Metal ì§€ì›:"
        if system_profiler SPDisplaysDataType 2>/dev/null | grep -q "Metal"; then
            echo "  âœ… Metal ì§€ì›ë¨"
            # Metal GPU ì •ë³´
            local metal_info=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A 5 "Metal")
            echo "$metal_info" | grep "Metal" | while read line; do
                echo "  $line"
            done
        else
            echo "  âŒ Metal ì§€ì›ë˜ì§€ ì•ŠìŒ"
        fi
        
        # GPU ì‚¬ìš©ëŸ‰ í™•ì¸ (powermetrics ì‚¬ìš©, ê¶Œí•œì´ ìˆì„ ê²½ìš°)
        echo ""
        echo "GPU ì‚¬ìš©ë¥ :"
        if command -v powermetrics >/dev/null 2>&1; then
            local gpu_usage=$(sudo powermetrics -n 1 -s gpu_power 2>/dev/null | grep "GPU HW active residency" | awk '{print $5}' | head -1)
            if [[ -n "$gpu_usage" ]]; then
                echo "  í˜„ì¬ ì‚¬ìš©ë¥ : ${gpu_usage}%"
            else
                echo "  ì‚¬ìš©ë¥  ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ê¶Œí•œ í•„ìš”)"
            fi
        else
            echo "  powermetricsë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        fi
        
        # ì™¸ë¶€ GPU í™•ì¸
        echo ""
        echo "ì™¸ë¶€ GPU:"
        if system_profiler SPThunderboltDataType 2>/dev/null | grep -q "eGPU"; then
            echo "  ğŸ”Œ ì™¸ë¶€ GPUê°€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
            system_profiler SPThunderboltDataType 2>/dev/null | grep -A 3 "eGPU"
        else
            echo "  ì™¸ë¶€ GPUê°€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
        fi
        
        # ë””ìŠ¤í”Œë ˆì´ ì •ë³´
        echo ""
        echo "ì—°ê²°ëœ ë””ìŠ¤í”Œë ˆì´:"
        system_profiler SPDisplaysDataType 2>/dev/null | grep -E "Display Type|UI Looks like|Pixel Width|Pixel Height" | while read line; do
            echo "  $line"
        done
        
    else
        # Linux ì‹œìŠ¤í…œ
        echo "GPU ì •ë³´:"
        
        # NVIDIA GPU í™•ì¸
        if command -v nvidia-smi >/dev/null 2>&1; then
            echo ""
            echo "NVIDIA GPU:"
            nvidia-smi --query-gpu=name,memory.total,memory.used,temperature.gpu,utilization.gpu --format=csv,noheader,nounits | while IFS=',' read name memory_total memory_used temp util; do
                echo "  ğŸ® ${name// /}"
                echo "  ğŸ’¾ ë©”ëª¨ë¦¬: ${memory_used// /}MB / ${memory_total// /}MB"
                echo "  ğŸŒ¡ï¸  ì˜¨ë„: ${temp// /}Â°C"
                echo "  âš¡ ì‚¬ìš©ë¥ : ${util// /}%"
            done
        fi
        
        # AMD GPU í™•ì¸
        if command -v rocm-smi >/dev/null 2>&1; then
            echo ""
            echo "AMD GPU:"
            rocm-smi --showproductname --showmeminfo --showtemp --showuse
        fi
        
        # ì¼ë°˜ì ì¸ GPU ì •ë³´ (lspci ì‚¬ìš©)
        if command -v lspci >/dev/null 2>&1; then
            echo ""
            echo "PCI GPU ì •ë³´:"
            lspci | grep -i vga | while read line; do
                echo "  $line"
            done
        fi
    fi
    
    echo ""
}

# í•¨ìˆ˜ ì‹¤í–‰ (ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ì‹¤í–‰ë  ë•Œ)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]] || [[ "${(%):-%x}" == "${0}" ]]; then
    check_gpu "$@"
fi
